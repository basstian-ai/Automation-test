name: AI Dev Agent

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  iter:
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: basstian-ai/simple-pim-1754492683911
      TARGET_BRANCH: main
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      VERCEL_TOKEN:    ${{ secrets.VERCEL_TOKEN }}
      VERCEL_TEAM_ID:  ${{ secrets.VERCEL_TEAM_ID }}
      VERCEL_PROJECT:  ${{ secrets.VERCEL_PROJECT }}
      PAT_TOKEN:       ${{ secrets.PAT_TOKEN }}

    steps:
      # 1) Check out automation repo (this repo)
      - uses: actions/checkout@v4

      # 2) Clone target repo fresh into ./target
      - name: Clone target repo
        run: |
          rm -rf target
          git clone https://x-access-token:${{ secrets.PAT_TOKEN }}@github.com/${{ env.TARGET_REPO }} target
          cd target
          git checkout ${{ env.TARGET_BRANCH }}

      # 3) Install deps for automation agent
      - name: Install agent dependencies
        run: npm ci

      # 4) Run the AI iteration agent inside target folder
      - name: Run AI Dev Agent
        run: |
          cd target
          NODE_OPTIONS="--openssl-legacy-provider --max-old-space-size=8192" node ../ai-iter-agent.js
        env:
          TARGET_REPO: ${{ env.TARGET_REPO }}
          TARGET_BRANCH: ${{ env.TARGET_BRANCH }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          VERCEL_TOKEN:    ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM_ID:  ${{ secrets.VERCEL_TEAM_ID }}
          VERCEL_PROJECT:  ${{ secrets.VERCEL_PROJECT }}
          PAT_TOKEN:       ${{ secrets.PAT_TOKEN }}

      # 5) Commit & push results
      - name: Commit & Push changes
        run: |
          cd target
          git config user.name "AI Iteration Bot"
          git config user.email "bot@example.com"
          git add .
          git commit --allow-empty -m "AI iteration update [skip ci]"
          git push origin ${{ env.TARGET_BRANCH }}