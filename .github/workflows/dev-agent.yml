name: Dev Agent Iteration

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # every hour â€” adjust as needed

permissions:
  contents: write

jobs:
  iter:
    runs-on: ubuntu-24.04

    env:
      TARGET_REPO: basstian-ai/simple-pim-1754492683911
      TARGET_BRANCH: main
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
      VERCEL_PROJECT: ${{ secrets.VERCEL_PROJECT }}
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

    steps:
      - name: Checkout automation repo
        uses: actions/checkout@v4

      - name: Clone target repo
        run: |
          rm -rf target
          git clone https://${{ secrets.PAT_TOKEN }}@github.com/${TARGET_REPO}.git target
          cd target
          git config user.name "AI Dev Agent"
          git config user.email "ai-agent@example.com"
          git checkout ${TARGET_BRANCH}

      - name: Install deps for target
        run: |
          cd target
          npm ci || npm install

      - name: Run AI iteration
        run: |
          cd target
          NODE_OPTIONS="--openssl-legacy-provider --max-old-space-size=8192" node ../ai-iter-agent.js

      - name: Push changes
        run: |
          cd target
          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit."
          else
            git commit -m "AI iteration: $(date -u +"%Y-%m-%d %H:%M:%S UTC")"
            git push origin ${TARGET_BRANCH}
          fi

      - name: Deploy to Vercel
        run: |
          cd target
          npx vercel --token $VERCEL_TOKEN --scope $VERCEL_TEAM_ID --prod --confirm