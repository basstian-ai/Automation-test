name: AI Dev Agent

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  iter:
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: basstian-ai/simple-pim-1754492683911
      TARGET_BRANCH: main
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_TEAM_ID: ${{ secrets.VERCEL_TEAM_ID }}
      VERCEL_PROJECT: ${{ secrets.VERCEL_PROJECT }}
      PAT_TOKEN: ${{ secrets.PAT_TOKEN }}

    steps:
      # 1) Checkout automation repo (this repo)
      - uses: actions/checkout@v4
        with:
          path: automation

      # 2) Checkout target PIM repo
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.PAT_TOKEN }}
          ref: ${{ env.TARGET_BRANCH }}
          path: target

      # 3) Install automation repo dependencies
      - name: Install automation dependencies
        run: npm ci
        working-directory: automation

      # 4) Run AI Dev Agent inside target repo
      - name: Run AI Dev Agent in target repo
        working-directory: target
        run: |
          NODE_OPTIONS="--openssl-legacy-provider --max-old-space-size=8192" \
          node ../automation/ai-iter-agent.js

      # 5) Commit & push if changes
      - name: Commit and push changes
        working-directory: target
        run: |
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git config --global user.name "github-actions[bot]"
          git add .
          if git diff --cached --quiet; then
            echo "No changes to commit"
          else
            git commit -m "AI iteration update"
            git push origin ${{ env.TARGET_BRANCH }}
          fi