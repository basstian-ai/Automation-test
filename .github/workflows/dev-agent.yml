# .github/workflows/dev-agent.yml
name: AI Dev Agent

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  iter:
    runs-on: ubuntu-latest
    env:
      TARGET_REPO: basstian-ai/simple-pim-1754492683911
      TARGET_BRANCH: main
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      VERCEL_TOKEN:    ${{ secrets.VERCEL_TOKEN }}
      VERCEL_TEAM_ID:  ${{ secrets.VERCEL_TEAM_ID }}
      VERCEL_PROJECT:  ${{ secrets.VERCEL_PROJECT }}
      PAT_TOKEN:       ${{ secrets.PAT_TOKEN }}

    steps:
      # 1) Sjekk ut **agent-repoet** (dette) i ./agent
      - uses: actions/checkout@v4
        with:
          path: agent

      # 2) Sjekk ut **PIM-målet** i ./target
      - uses: actions/checkout@v4
        with:
          repository: ${{ env.TARGET_REPO }}
          token: ${{ secrets.PAT_TOKEN }}     # trengs for push-tilgang
          path: target

      # 3) Installer agent-avhengigheter
      - name: Install agent deps
        run: npm ci
        working-directory: agent

      # 4) Kjør agenten INNE i target-mappen
      - name: Run AI Dev Agent
        run: node --max-old-space-size=8192 ../agent/ai-iter-agent.js
        working-directory: target

        env:
          # sender videre alle env-variablene som allerede er satt
          TARGET_REPO: ${{ env.TARGET_REPO }}
          TARGET_BRANCH: ${{ env.TARGET_BRANCH }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          VERCEL_TOKEN:    ${{ secrets.VERCEL_TOKEN }}
          VERCEL_TEAM_ID:  ${{ secrets.VERCEL_TEAM_ID }}
          VERCEL_PROJECT:  ${{ secrets.VERCEL_PROJECT }}
          PAT_TOKEN:       ${{ secrets.PAT_TOKEN }}
