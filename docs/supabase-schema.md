# Supabase Schema

The `roadmap_items` table is the canonical backlog and replaces the older `tasks` table.

## roadmap_items

| Column     | Type                                                | Notes |
|------------|-----------------------------------------------------|-------|
| id         | bigint, primary key                                 | generated by default as identity |
| title      | text, not null                                      | |
| content    | text                                                | optional |
| type       | enum ('idea','task','bug','done'), not null         | |
| repo       | text, not null                                      | indexed |
| priority   | integer                                             | optional |
| created | timestamptz, default timezone('utc', now())         | |
| status     | text                                                | optional |

### Indices

- `roadmap_items_type_idx` on `type`
- `roadmap_items_repo_idx` on `repo`
- `roadmap_items_priority_idx` on `priority`

### SQL

```sql
create type roadmap_item_type as enum ('idea','task','bug','done');

create table roadmap_items (
  id bigint generated by default as identity primary key,
  title text not null,
  content text,
  type roadmap_item_type not null,
  repo text not null,
  priority int,
  created timestamptz default timezone('utc', now()),
  status text
);

create index roadmap_items_type_idx on roadmap_items(type);
create index roadmap_items_repo_idx on roadmap_items(repo);
create index roadmap_items_priority_idx on roadmap_items(priority);
```

Older deployments may still use a `created_at` column. To migrate:

```sql
alter table roadmap_items rename column created_at to created;
```


## roadmap_item_log

| Column     | Type                                        | Notes |
|------------|---------------------------------------------|-------|
| id         | bigint, primary key                         | generated by default as identity |
| item_id    | bigint, references roadmap_items(id)        | |
| completed_at | timestamptz, default timezone('utc', now()) | |

### SQL

```sql
create table roadmap_item_log (
  id bigint generated by default as identity primary key,
  item_id bigint references roadmap_items(id),
  completed_at timestamptz default timezone('utc', now())
);
```

## RPCs

### complete_task

Marks a roadmap item as completed and records the action in `roadmap_item_log`.
Legacy deployments may still expose this RPC as `complete_roadmap_task`.

```sql
create or replace function complete_task(
  task_id bigint,
  title text,
  description text,
  priority int
) returns void as $$
begin
  update roadmap_items
    set title = coalesce(complete_task.title, roadmap_items.title),
        content = complete_task.description,
        priority = complete_task.priority,
        type = 'done'
    where id = complete_task.task_id;

  insert into roadmap_item_log(item_id) values (complete_task.task_id);
end;
$$ language plpgsql;
```
